rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwnUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // User collection: Users can manage their own data.
    match /users/{userId} {
      allow read, update: if isOwnUser(userId);
      allow create: if isSignedIn();
    }

    // Rides collection
    match /rides/{rideId} {
      // ANY signed-in user can read rides. This allows drivers to see open requests.
      allow read: if isSignedIn();
      
      // Only signed-in users can create rides.
      allow create: if isSignedIn();

      // Only the customer or an assigned driver can update the ride.
      allow update: if isSignedIn() && 
                     (request.resource.data.customerId == request.auth.uid || 
                      resource.data.driverId == request.auth.uid);
    }

    // Wallet requests collection: Signed-in users can create requests.
    match /walletRequests/{requestId} {
        allow create: if isSignedIn();
        // Admins would typically be the only ones to read/update, handled by backend logic for now.
    }
  }
}