rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if the user is an admin
    function isAdmin() {
      // The UID for the admin user: info@zingoride.vercel.app
      return request.auth.uid == 'vfYyFADwO2a7txbK1YPYLzh2dFv1';
    }

    // Users can read/write their own data.
    // Admins can read/write any user's data.
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId || isAdmin();
    }
    
    // Customers can create their own rides.
    // The authenticated user (customer or driver) involved in the ride can read/update it.
    // Admins can read/write any ride.
    match /rides/{rideId} {
      allow read, update: if request.auth.uid == resource.data.customerId || request.auth.uid == resource.data.driverId || isAdmin();
      allow create: if request.auth.uid == request.resource.data.customerId;
    }
    
    // Chat messages can only be read/written by the participants of the chat/ride or admins.
    match /rides/{rideId}/messages/{messageId} {
      allow read, create: if request.auth.uid == get(/databases/$(database)/documents/rides/$(rideId)).data.customerId || request.auth.uid == get(/databases/$(database)/documents/rides/$(rideId)).data.driverId || isAdmin();
    }
    
    // General chat messages can only be read/written by participants or admins.
    // Chat ID is formatted as 'uid1_uid2'
    match /chats/{chatId}/messages/{messageId} {
      allow read, create: if request.auth.uid in chatId.split('_') || isAdmin();
    }
    
    // Wallet requests can be created by any authenticated user.
    // Only admins can read/update/delete them.
    match /walletRequests/{requestId} {
      allow create: if request.auth.uid != null;
      allow read, update, delete: if isAdmin();
    }
    
    // Only admins can read, create, update, or delete payout requests.
    match /payoutRequests/{requestId} {
      allow read, write: if isAdmin();
    }
    
    // Notifications can only be managed by admins.
    match /notifications/{notificationId} {
        allow read, write: if isAdmin();
    }
  }
}
